using AdventOfCode2020.Models;
using System;
using System.Collections.Generic;
using System.Text;
using System.Linq;

namespace AdventOfCode2020
{
    public static class Day03
    {
        //public static List<string> input = new List<string>() { "..##.......", "#...#...#..", ".#....#..#.", "..#.#...#.#", ".#...##..#.", "..#.##.....", ".#.#.#....#", ".#........#", "#.##...#...", "#...##....#", ".#..#...#.#" };
        public static List<string> input = new List<string>() { ".........#.#.#.........#.#.....","...#......#...#.....#.....#....","#.....#.....#.....#.#........#.","......#..#......#.......#......",".#..........#.............#...#","............#..##.......##...##","....#.....#..#....#............",".#..#.........#....#.#....#....","#.#...#...##..##.#..##..#....#.",".#.......#.#...#..........#....","...#...#........##...#..#.....#","..................#..........#.",".....#.##..............#.......","........#....##..##....#.......","...#.....#.##..........#...##..",".......#.#....#............#...","..............#......#......#..","#.......#...........#........##",".......#.......##......#.......","................#....##...#.#.#","#.......#....................#.",".##.#..##..#..#.#.....#.....#..","#...#............#......##....#",".#....##.#......#.#......#..#..","..........#........#.#.#.......","...#...#..........#..#....#....","..#.#...#...#...##...##......#.","......#...#........#.......###.","....#...............#.###...#.#","..................#.....#..#.#.",".#...#..#..........#........#..","#..........##................##","...#.....#...#......#.#......#.","......#..........#.#......#..#.","..#......#.....................","............#.........##.......","......#.......#........#.......","#.#...#...........#.......#....",".#.#........#.#.#....#........#","#.....##........#.#.....#.#....",".#...#..........##...#.....#..#",".........#....###............#.","..#...#..............#.#.#.....",".....#.#.#..#.#.#.###......#.#.",".#.##...#.......###..#.........",".....##....#.##..#.##..#.......","..#...........##......#..#.....","................##...#.........","##.....................#..#.###","...#..#....#...........#.......",".#.............##.#.....#.#....",".......#.#.#....##..#....#...#.","...##..#..........#....#.......","....##......#.........#........",".##....#...........#.#.......#.","...#...#.##.......#.#..........","..#.........#.##...........#...","....#.##........#.......#...##.","...................#..#..#...##","#...#......###..##.#..###......","#.............#.#........#...#.","...#...#..#..#..............#..","#.....#..#...#...#......#.#..#.","...##.............#........##.#","......#.#.........#.#....#...#.","........##............#...#....","............#.#...#......#.....","...#...........#...#...........",".........#.#......#............","....#.............#..#.....#..#","#.....#...........#.....#.#.#.#",".............#.....##......#...","...................###.#......#","#.##.....#...#..#..#...#....#..","............#.....#....#.#.....","#....#..#..........#....#..#...","..........##..................#","....#.......###..#......###....",".......#...#.##.##..#....##....","...##...............#.....#...#","#...........#...#......#..#..#.","..##....#.......#...#.....#....",".......##..............#.##..#.",".#......#..........#.......#...","....##...................#.#..#","......#....###................#",".#........#...........#........",".#.....##....#..##...........#.","##..............##...#.......#.","......#..........#..........##.","..#.....#.#.........####....#..",".............#......#......#...","..#.............#...........##.","#.#...#........#..........##...","...#....#.....#.....#.....##...","......#........................","......#..#...#......#.....#....","......#....##.....#....#.......","#.#......#.##..#...............","..........#.#.##..##..#........","......#.#..#....###.#..........","........................#....#.","#.#.............#....#.....##.#",".#.#..........#.......#..#....#","..#...#......#..#..#...#.#...#.","...#.##...###..................","........#.#...........#...#....","........#..........#....#......","#....#........#.......##.....#.","......###...##...#......#......","............#.......#.....##..#","....#..#.......##......#.......","#............##................","...............#..#......#...#.",".#....##...#......#............","#...#................#.........","..#....#..#........##......#...","....#....###......##.#.......#.","......#.#..#.#..#....#..#......","....#..........#..#..#.........",".#..#.......#......#........#..",".......#..#..#............#....",".............#...#....#..#.....","..............#.#.#.........#..","#.....##.......#....#..........","...#.....#......#..............","...##.#..#.#........#..##....#.",".......#.#.....##..#...........",".....#.#....#..................",".#......#.###..............##..","..#....#...#..#...##...##....#.","..........##..#...#..#.........","..#............#........#.#...#",".........................#.#.#.","......#........#.#..#......##.#","#.#......#..#.........#........",".....#........#......#...#.#...","........##....##....#.#........","....#....#.#...#...##....#..#..","#.............#.....#..........","#............##..#............#","..#.#......#........#..........",".#......#......#.#.##.##.......","..#.....#..........#......##...","...#......#...#.##....#.....##.","......#......#...........#.#...","....#........#..#..#........#.#","....#.........#.....#...#.#.#..","....#.....###........#.........",".............##........#.#.....","...#............#........#.#.#.","......#....#.......#.#.........",".....#................#........",".#....#..#.#.............#...#.","#..##...#............#......#..","...#..#........................",".#.#...........#.......#.......","#....###............##.........","...##....#.#............##.....",".........####......#........#..",".....#.......#.#...............",".......#...#.###..#....#...#..#","...#.....##..#....#..#.#...###.",".............#........#.#.#..#.","................#..........##..",".......####..##..##........##.#","..#......#..#..#.#.##..........","#....#........#....#...###.#.#.","........##........##.....#.....","...........#.#...........#....#","#.............#...........#....","...#.........#...#....#.....#..","..##......#...#...............#",".............#.........#....#..","..#...........#..#........#.##.",".#.#......#.............##...#.",".#......#.....##.#..#..#.......","....##......#..................",".#.#..##............#....#....#","........#...##.............#..#","........#....##.....#......###.",".........#....#.#..............","#.....#........................",".#..#....#.....#......#.###..#.","..........#...#....##....#..#..","...#.#.#...##..#..#......#..#.#","#............#.....#....#......","#.###...#.#......###..#....#..#","...#.###........#......#....#..","..#.##...#.........#.#.........","............##.................","....#..........#.#.#.#.#....#..","...##.#...#.......#.......##..#","....##.#........#....#...#.....",".............#.#....#...#.....#","...#......................##...","..#...#.....#.....#........#..#","..#..#.......#....#..##.....#..","..#..#.#.......................",".......##..#....#....#..#......","....#......##....#............#",".#...#..#..#.##...#.#...#......",".....#......#....#.........#...",".##......##.........#....#.....","#...........#...##.....#......#",".....#.#.......#.........#.....",".........#..........#..####.##.","............#..#......#.#......",".#.............#........#.#....","......#......#...#..#....#####.",".........##.#..##...###..#....#","....#.#....#.#..#.........#....","..#.............#...##...##....","........#..........#.##..#....#",".....#...#..##........#.#..#...","##..#.#.....#............#.....",".............#........##...##..","#......####.....##.............","..##.....##....###..#.#....#...","......##.##.#...#..#.#..##.....","......#.................#......","#.....#.#...#......#.#....#....","....#.#........#..............#","##........#.......##.#...##...#","..#..................#.#....#..","...........#..........#.#.....#","........##.#.....#......#..#..#",".....#....#..#.....#.........##","#.#..#..#...#......#..........#","#...##.....#..#.#.......#.##...","..#....##...............#......","#..........#.#.........#.#....#","..............#......#....#....",".....#...........#...#...#...#.","...#......#....#....#..........",".#..........#.#....##..##....#.","..............#.........#.#....",".......#.....#.....#...##....#.","##.#.........#....#.....#.#....","....#..#......#................","......##.....#.......##........",".....##...#........#...#...#...","..#...#...#..#..#.#......#..#..","....#...#.......#..............","....#..#.........###........#..","....#.............##..#........","..........##.#.......##..##....","#.##..................#.....#..","#........#........#.....#......",".#...#......#..................","#....##.##......#...#.........#","......#.##..##................#","............#.........##.......","..........####.#........#.....#",".##...#...#....#..#............",".#.##...#..#...#......#......##",".....#.#....#..###......#.#.#..","...#.......................##..","......................#.......#","..#....#.........#..#.#.....#..",".#....#..#....#...#............","..........#...##.....#.#..#....","........#..#..#....#...#...#...",".....#......#.#................",".....#...........#...#.........",".....#...##..#.#....#..#.....#.","#.......#.............##.......","................#....#.#..#....",".#..##...#.#........#......#.#.",".#.##..........#...............","....##......#....#........#....","....#..#....#.##.#.............",".......#..#......##.#.....#....",".......#.....#.............#...",".....#....#.......#............","........#.#...##..##..##.......","#.........##....##...##........","........#..#.#..........###.#..","..........................#.#..","#.....#.......#..#........#....","...##.....#.......#......#.....",".#.#..#...........#...........#",".....##..#........#...####.....",".#.#...##.#.#..#..#.#..#.......","..#.##.#...#.#.#...#..#........","............#..........#..#....","...............#..##.#.........",".............#.....#....#......","...##..##......##..........#...","..#.......#....#..........#...#",".##................#.#.#.......",".....##.....#..#.....#.........","......#.#.......#......#..#....",".....#.....#........#.......##.","......#.......##......#...#...#","....#...........###.........#..","...#.....#.........##........#.","..#.....#..............#.......","....#.......#...#....#....#..##","......#...........#...........#",".##......#......#.#.....#.##...","....#..##......#...#..#.#.###..",".......#.#....#......#..#......","..........#........#...........","#.##.........#.#.#...#...#.#...",".#......###.....#....#.#....#..","...................##..#.......","....#..#..............#.#.....#","#..................#.....#.....","...........##.##.......#..#.#..","........#.#......#...........#.","#..#.......#...#...........#.#.","......##...........#...........",".........#.#........#........#.","#......#....#.#.....#..#.......","............#..#.....##...#....",".#......#..#......#.........#..",".......#...#.........#.##.....#","........................#..#...",".###..............#.#..#.......",".....#.........#.......#......#","..##..##....#.....#.......#.#..","...###.#..#.##............#...." };

        public static void Part1()
        {
            HashSet<Point> treePoints = new HashSet<Point>();
            Rect r = BuildTreePointsList(treePoints);

            Point pos = new Point(0, 0);
            Point move = new Point(3, 1);
            List<Point> encounterPoints = GetEncounterPoints(treePoints,  r, pos, move);

            Console.WriteLine($"{encounterPoints.Count} trees encountered");
        }

        public static void Part2()
        {
            HashSet<Point> treePoints = new HashSet<Point>();
            Rect r = BuildTreePointsList(treePoints);

            Point pos = new Point(0, 0);
            List<int> treesEncounteredOnSlopes = new List<int>();
            treesEncounteredOnSlopes.Add(GetEncounterPoints(treePoints, r, pos, new Point(1, 1)).Count);
            treesEncounteredOnSlopes.Add(GetEncounterPoints(treePoints, r, pos, new Point(3, 1)).Count);
            treesEncounteredOnSlopes.Add(GetEncounterPoints(treePoints, r, pos, new Point(5, 1)).Count);
            treesEncounteredOnSlopes.Add(GetEncounterPoints(treePoints, r, pos, new Point(7, 1)).Count);
            treesEncounteredOnSlopes.Add(GetEncounterPoints(treePoints, r, pos, new Point(1, 2)).Count);

            Console.WriteLine($"Answer is {treesEncounteredOnSlopes.Aggregate(1, (i, s) => i *= s )} ");
        }

        private static List<Point> GetEncounterPoints(HashSet<Point> treePoints, Rect r, Point start, Point move)
        {
            bool quit = false;
            Point pos = start;
            List<Point> encounterPoints = new List<Point>();
            do
            {
                //Console.WriteLine(pos);
                if (treePoints.Contains(pos))
                {
                    encounterPoints.Add(pos);
                }
                int oldY = pos.Y;
                pos = pos.AddPointsToroid(move, r);
                if (pos.Y < oldY) quit = true;
            }
            while (!quit);
            return encounterPoints;
        }

        private static Rect BuildTreePointsList(HashSet<Point> treePoints)
        {
            int width = input[0].Length;
            int height = input.Count;
            bool invalid = input.Any(s => s.Length != width);
            if (invalid) throw new Exception("bad input");

            for (int x = 0; x < width; x++)
            {
                for (int y = 0; y < height; y++)
                {
                    Point p = new Point(x, y);
                    if (input[y][x] == '#') treePoints.Add(p);
                }
            }
            return new Rect(0, 0, width, height);
        }
    }
}
